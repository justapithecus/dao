version: "3"

env:
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: "plain"
  BUILD_OS: "linux"
  BUILD_COMPILER: "clang"
  BUILD_TYPE: "Debug"

  # TODO (andrew): disambiguate host vs target (a.k.a. conan build) settings

tasks:
  lock:
    cmds:
      - |
        devbox run conan lock create . \
          --profile:host="profiles/${BUILD_OS}.${BUILD_COMPILER}.ini" \
          --profile:build="profiles/${BUILD_OS}.${BUILD_COMPILER}.ini"

  install:
    cmds:
      - |
        devbox run conan install . \
          --profile:host="profiles/${BUILD_OS}.${BUILD_COMPILER}.ini" \
          --profile:build="profiles/${BUILD_OS}.${BUILD_COMPILER}.ini" \
          --output-folder="build" \
          --build=missing \
          --settings=build_type=${BUILD_TYPE}

  generate:
    aliases: [gen]
    cmds:
      - devbox run cmake . --preset default

  clean: devbox run cmake --build --preset default --target clean

  build: time devbox run cmake --build --preset default

  run: ./build/apps/daoc/daoc

  test: devbox run ctest --test-dir build --preset default --output-on-failure --verbose
